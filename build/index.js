(()=>{"use strict";const e=window.wp.blocks,t=window.wp.i18n,n=window.wp.element,o=window.wp.data,a=window.wp.blockEditor,r=[239,187,191],l="https://api.openai.com/v1/",i=window.wp.components,c=function(e){const{attributes:o,setAttributes:r,isLoading:l,onGenerateClick:c}=e;return(0,n.createElement)(a.BlockControls,null,(0,n.createElement)(i.ToolbarGroup,null,(0,n.createElement)(a.AlignmentToolbar,{value:o.alignment,onChange:e=>r({alignment:e})}),(0,n.createElement)(i.ToolbarButton,{icon:l?(0,n.createElement)(i.Spinner,null):"lightbulb",label:(0,t.__)("Generate Text","andika"),onClick:c,isPressed:l,disabled:l})))},s=e=>{let{attributes:o,setAttributes:r}=e;const{lineHeight:l}=o;return(0,n.createElement)(a.InspectorControls,null,(0,n.createElement)(i.PanelBody,{title:(0,t.__)("Andika Controls","andika")},(0,n.createElement)(i.SelectControl,{label:(0,t.__)("Text Length","andika"),value:o.andikaTextLength,options:[{label:"Short",value:"short"},{label:"Medium",value:"medium"},{label:"Long",value:"long"}],onChange:e=>r({andikaTextLength:e})})),(0,n.createElement)(i.PanelBody,{title:(0,t.__)("Typography","andika")},(0,n.createElement)(a.FontSizePicker,{value:o.fontSize,onChange:e=>r({fontSize:e}),__nextHasNoMarginBottom:!0}),(0,n.createElement)(i.RangeControl,{label:(0,t.__)("Line height","andika"),value:l,onChange:e=>{r({lineHeight:e})},min:1,max:3,step:.1})),(0,n.createElement)(a.PanelColorSettings,{title:(0,t.__)("Color settings","andika"),initialOpen:!1,colorSettings:[{value:o.textColor,onChange:e=>r({textColor:e}),label:(0,t.__)("Text color","andika")},{value:o.backgroundColor,onChange:e=>r({backgroundColor:e}),label:(0,t.__)("Background color","andika")}]}))},d=JSON.parse('{"u2":"andika-block/andika","TN":"Andika","W3":"text","qv":"lightbulb","WL":"Elevate your writing with real-time AI text generation using Andika.","Y4":{"content":{"type":"string","source":"html","selector":"p"},"element":{"type":"string","default":"p"},"alignment":{"type":"string","default":"none"},"backgroundColor":{"type":"string"},"textColor":{"type":"string"},"fontSize":{"type":"string"},"lineHeight":{"type":"number","default":1.5},"andikaTextLength":{"type":"string","default":"medium"}}}'),u={h1:1,h2:2,h3:3,h4:4,h5:5,h6:6},p={1:"h1",2:"h2",3:"h3",4:"h4",5:"h5",6:"h6"},g={from:[{type:"block",blocks:["core/paragraph"],transform:t=>{let{content:n}=t;return(0,e.createBlock)("andika-block/andika",{content:n})}},{type:"block",blocks:["core/heading"],transform:t=>{let{content:n,level:o}=t;return(0,e.createBlock)("andika-block/andika",{content:n,element:p[o]})}}],to:[{type:"block",blocks:["core/paragraph"],transform:t=>{let{content:n}=t;return(0,e.createBlock)("core/paragraph",{content:n})}},{type:"block",blocks:["core/heading"],transform:t=>{let{content:n,element:o}=t;return(0,e.createBlock)("core/heading",{content:n,level:u.hasOwnProperty(o)?u[o]:2})}}]};(0,e.registerBlockType)(d.u2,{title:(0,t.__)(d.TN),icon:d.qv,category:d.W3,description:(0,t.__)(d.WL),transforms:g,supports:{html:!0,className:!1},attributes:d.Y4,edit:function(i){let{attributes:d,setAttributes:u,isSelected:p,clientId:g}=i;const{content:k,alignment:h,fontSize:m,textColor:b,backgroundColor:f}=d,[y,v]=(0,n.useState)(!1),[_,w]=(0,n.useState)(k||""),{onSplit:x,onMerge:C,onReplace:S}=((t,n,r,l,i)=>{const{insertBlocks:c,replaceBlocks:s,removeBlock:d}=(0,o.useDispatch)(a.store),{getBlock:u,getBlockOrder:p,getBlockIndex:g}=(0,o.useSelect)((e=>e(a.store)),[]);return{onSplit:(o,a)=>{if(a){const e=n.slice(0,n.indexOf(o));r({content:e}),l(e)}const i={...t,content:o};return(0,e.createBlock)("andika-block/andika",i)},onReplace:(e,n)=>{s(n,e.map(((e,n)=>0===n&&"andika-block/andika"===e.name?{...e,...t,...e.attributes}:e)))},onMerge:e=>{const t=g(e),o=p(),a=o[t-1];if(a){const e=u(a);if("andika-block/andika"===e.name){const t=e.attributes.content+n;return r({content:t}),l(t),void d(a)}}const i=o[t+1];if(i){const e=u(i);if("andika-block/andika"===e.name){const t=n+e.attributes.content;r({content:t}),l(t),d(i)}}}}})(d,_,u,w),E=(0,n.useRef)(),{insertBlocks:T}=((0,a.useBlockProps)(),(0,o.useDispatch)(a.store)),{createNotice:B}=(0,o.useDispatch)("core/notices"),A=(0,o.useSelect)((e=>e("core/editor").getEditedPostAttribute("title"))),N=(0,o.useSelect)((e=>e(a.store).getBlocks())),P=N.length>0?N.slice(0,-1).map((e=>e.attributes.content)).join("\n"):"";(0,n.useEffect)((()=>{(e=>{if(!e.current)return;const t=document.createRange(),n=window.getSelection();if(""===_)t.setStart(e.current,0);else{const n=e.current.lastChild;n&&t.setStartAfter(n)}t.collapse(!0),n.removeAllRanges(),n.addRange(t),e.current.focus()})(E),u({content:_})}),[_,u]);const L=(0,n.useCallback)((async()=>{v(!0);const t=`Title: ${A}\n\n${P}\n\n${_}`,n=d.andikaTextLength;try{await async function(t,n,o,a,i,c){const s=new class{constructor(e){this.apiKey=e.api_key,this.model=e.model,this.temperature=parseFloat(e.temperature),this.top_p=parseFloat(e.topP),this.frequency_penalty=parseFloat(e.frequencyPenalty),this.presence_penalty=parseFloat(e.presencePenalty),this.stream="1"===e.stream}get_api_url(){return"gpt-3.5-turbo"===this.model||"gpt-4"===this.model?`${l}chat/completions`:`${l}completions`}async andikaText(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=this.get_api_url(),a={model:this.model,temperature:this.temperature,top_p:this.top_p,frequency_penalty:this.frequency_penalty,presence_penalty:this.presence_penalty,stream:this.stream,n:1,max_tokens:n.max_tokens,...n};"gpt-3.5-turbo"===this.model||"gpt-4"===this.model?a.messages=[{role:"user",content:e}]:a.prompt=e;const l={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(a)};try{const e=await fetch(o,l);if(!e.ok){const t=await e.json();throw console.error("Error response from OpenAI API:",t),new Error(e.statusText)}const n=function(e){let t,n,o,a,l,i,c;return s(),{feed:function(e){n=n?n+e:e,t&&function(e){return r.every(((t,n)=>e.charCodeAt(n)===t))}(n)&&(n=n.slice(r.length)),t=!1;const l=n.length;let i=0,c=!1;for(;i<l;){c&&("\n"===n[i]&&++i,c=!1);let e,t=-1,r=a;for(let a=o;t<0&&a<l;++a)e=n[a],":"===e&&r<0?r=a-i:"\r"===e?(c=!0,t=a-i):"\n"===e&&(t=a-i);if(t<0){o=l-i,a=r;break}o=0,a=-1,d(n,i,r,t),i+=t+1}i===l?n="":i>0&&(n=n.slice(i))},reset:s};function s(){t=!0,n="",o=0,a=-1,l=void 0,i=void 0,c=""}function d(t,n,o,a){if(0===a)return c.length>0&&(e({type:"event",id:l,event:i||void 0,data:c.slice(0,-1)}),c="",l=void 0),void(i=void 0);const r=o<0,s=t.slice(n,n+(r?a:o));let d=0;d=r?a:" "===t[n+o+1]?o+2:o+1;const u=n+d,p=a-d,g=t.slice(u,u+p).toString();if("data"===s)c+=g?"".concat(g,"\n"):"\n";else if("event"===s)i=g;else if("id"!==s||g.includes("\0")){if("retry"===s){const t=parseInt(g,10);Number.isNaN(t)||e({type:"reconnect-interval",value:t})}}else l=g}}(t),a=e.body.getReader(),i=new TextDecoder;for(;;){const{done:e,value:t}=await a.read();if(e)break;n.feed(i.decode(t))}}catch(e){return console.error("Error generating text:",e),"Error generating text! Check your API Key?"}}}(andika);let d="";const u=async t=>{if("event"===t.type&&"[DONE]"!==t.data)try{var r,l,c;const s=JSON.parse(t.data),u=(null!==(r=null!==(l=null!==(c=s.choices[0]?.text)&&void 0!==c?c:s.choices[0]?.message?.content)&&void 0!==l?l:s.choices[0]?.delta?.content)&&void 0!==r?r:"").replace(/^\n{1,2}/,"");if(u)if(d+=u,d.includes("\n")){const t=d.split(/\n+/).filter((e=>""!==e.trim())),o=t.map((t=>(0,e.createBlock)("andika-block/andika",{content:t}))),r=wp.data.select("core/block-editor").getBlockIndex(i);if(n&&n!==t[0]){const l=(0,e.createBlock)("andika-block/andika",{content:n+t[0]});wp.data.dispatch("core/block-editor").replaceBlock(i,l);const c=o.slice(1);a(c,r+1)}else a(o,r);d=""}else o(n+d)}catch(e){throw new Error("Error parsing JSON: "+e.message)}};let p;switch(c){case"short":p=24;break;case"medium":default:p=48;break;case"long":p=96}try{await s.andikaText(t,u,{max_tokens:p})}catch(e){throw new Error("Error in generateText: "+e.message)}}(t,_,w,T,g,n)}catch(e){B("error",`Text generation failed: ${e.message}`)}finally{v(!1)}}),[_,A,P,w,T,g,d.andikaTextLength]);return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(c,{attributes:d,setAttributes:u,isLoading:y,onGenerateClick:L}),(0,n.createElement)(s,{attributes:d,setAttributes:u}),(0,n.createElement)(a.RichText,{ref:E,tagName:"div",value:_,onChange:e=>{w(e),u({content:e})},className:"andika-placeholder",placeholder:(0,t.__)("Type and click the lightbulb icon to generate text...","andika"),isSelected:p,style:{textAlign:h,fontSize:m,color:b,backgroundColor:f},onSplit:x,onReplace:e=>S(e,g),onRemove:()=>S([]),onMerge:()=>C(g)}))},save:function(e){let{attributes:t}=e;return(0,n.createElement)(a.RichText.Content,{tagName:"p",value:t.content,style:{textAlign:t.alignment,fontSize:t.fontSize,color:t.textColor,backgroundColor:t.backgroundColor}})}})})();